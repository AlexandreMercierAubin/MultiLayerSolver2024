function [gradC,constraintC] = StVKconstraintGrad3D(DmInv, x)
    t2 = DmInv(1,1,:)+DmInv(2,1,:)+DmInv(3,1,:);
    t3 = DmInv(1,2,:)+DmInv(2,2,:)+DmInv(3,2,:);
    t4 = DmInv(1,3,:)+DmInv(2,3,:)+DmInv(3,3,:);
    t5 = -x(4,:,:);
    t6 = -x(5,:,:);
    t7 = -x(6,:,:);
    t8 = -x(7,:,:);
    t9 = -x(8,:,:);
    t10 = -x(9,:,:);
    t11 = -x(10,:,:);
    t12 = -x(11,:,:);
    t13 = -x(12,:,:);
    t14 = t5+x(1,:,:);
    t15 = t6+x(2,:,:);
    t16 = t8+x(1,:,:);
    t17 = t7+x(3,:,:);
    t18 = t9+x(2,:,:);
    t19 = t11+x(1,:,:);
    t20 = t10+x(3,:,:);
    t21 = t12+x(2,:,:);
    t22 = t13+x(3,:,:);
    t23 = DmInv(1,1,:).*t14;
    t24 = DmInv(1,2,:).*t14;
    t25 = DmInv(1,1,:).*t15;
    t26 = DmInv(1,3,:).*t14;
    t27 = DmInv(1,2,:).*t15;
    t28 = DmInv(1,1,:).*t17;
    t29 = DmInv(1,3,:).*t15;
    t30 = DmInv(1,2,:).*t17;
    t31 = DmInv(1,3,:).*t17;
    t32 = DmInv(2,1,:).*t16;
    t33 = DmInv(2,2,:).*t16;
    t34 = DmInv(2,1,:).*t18;
    t35 = DmInv(2,3,:).*t16;
    t36 = DmInv(2,2,:).*t18;
    t37 = DmInv(2,1,:).*t20;
    t38 = DmInv(2,3,:).*t18;
    t39 = DmInv(2,2,:).*t20;
    t40 = DmInv(2,3,:).*t20;
    t41 = DmInv(3,1,:).*t19;
    t42 = DmInv(3,2,:).*t19;
    t43 = DmInv(3,1,:).*t21;
    t44 = DmInv(3,3,:).*t19;
    t45 = DmInv(3,2,:).*t21;
    t46 = DmInv(3,1,:).*t22;
    t47 = DmInv(3,3,:).*t21;
    t48 = DmInv(3,2,:).*t22;
    t49 = DmInv(3,3,:).*t22;
    t50 = t23+t32+t41;
    t51 = t24+t33+t42;
    t52 = t25+t34+t43;
    t53 = t26+t35+t44;
    t54 = t27+t36+t45;
    t55 = t28+t37+t46;
    t56 = t29+t38+t47;
    t57 = t30+t39+t48;
    t58 = t31+t40+t49;
    mt1 = [t2.*t50;t2.*t52;t2.*t55;-DmInv(1,1,:).*t50;-DmInv(1,1,:).*t52;-DmInv(1,1,:).*t55;-DmInv(2,1,:).*t50;-DmInv(2,1,:).*t52;-DmInv(2,1,:).*t55;-DmInv(3,1,:).*t50;-DmInv(3,1,:).*t52;-DmInv(3,1,:).*t55;t3.*t51;t3.*t54;t3.*t57;-DmInv(1,2,:).*t51;-DmInv(1,2,:).*t54;-DmInv(1,2,:).*t57;-DmInv(2,2,:).*t51;-DmInv(2,2,:).*t54;-DmInv(2,2,:).*t57;-DmInv(3,2,:).*t51;-DmInv(3,2,:).*t54;-DmInv(3,2,:).*t57;t4.*t53;t4.*t56;t4.*t58;-DmInv(1,3,:).*t53;-DmInv(1,3,:).*t56;-DmInv(1,3,:).*t58;-DmInv(2,3,:).*t53;-DmInv(2,3,:).*t56;-DmInv(2,3,:).*t58;-DmInv(3,3,:).*t53;-DmInv(3,3,:).*t56;-DmInv(3,3,:).*t58;(t2.*t51)./2.0+(t3.*t50)./2.0;(t3.*t52)./2.0+(t2.*t54)./2.0];
    mt2 = [(t3.*t55)./2.0+(t2.*t57)./2.0;DmInv(1,1,:).*t51.*(-1.0./2.0)-(DmInv(1,2,:).*t50)./2.0;DmInv(1,2,:).*t52.*(-1.0./2.0)-(DmInv(1,1,:).*t54)./2.0;DmInv(1,2,:).*t55.*(-1.0./2.0)-(DmInv(1,1,:).*t57)./2.0;DmInv(2,1,:).*t51.*(-1.0./2.0)-(DmInv(2,2,:).*t50)./2.0;DmInv(2,2,:).*t52.*(-1.0./2.0)-(DmInv(2,1,:).*t54)./2.0;DmInv(2,2,:).*t55.*(-1.0./2.0)-(DmInv(2,1,:).*t57)./2.0;DmInv(3,1,:).*t51.*(-1.0./2.0)-(DmInv(3,2,:).*t50)./2.0;DmInv(3,2,:).*t52.*(-1.0./2.0)-(DmInv(3,1,:).*t54)./2.0;DmInv(3,2,:).*t55.*(-1.0./2.0)-(DmInv(3,1,:).*t57)./2.0;(t4.*t50)./2.0+(t2.*t53)./2.0;(t4.*t52)./2.0+(t2.*t56)./2.0;(t4.*t55)./2.0+(t2.*t58)./2.0];
    mt3 = [DmInv(1,3,:).*t50.*(-1.0./2.0)-(DmInv(1,1,:).*t53)./2.0;DmInv(1,3,:).*t52.*(-1.0./2.0)-(DmInv(1,1,:).*t56)./2.0;DmInv(1,3,:).*t55.*(-1.0./2.0)-(DmInv(1,1,:).*t58)./2.0;DmInv(2,3,:).*t50.*(-1.0./2.0)-(DmInv(2,1,:).*t53)./2.0;DmInv(2,3,:).*t52.*(-1.0./2.0)-(DmInv(2,1,:).*t56)./2.0;DmInv(2,3,:).*t55.*(-1.0./2.0)-(DmInv(2,1,:).*t58)./2.0;DmInv(3,3,:).*t50.*(-1.0./2.0)-(DmInv(3,1,:).*t53)./2.0;DmInv(3,3,:).*t52.*(-1.0./2.0)-(DmInv(3,1,:).*t56)./2.0;DmInv(3,3,:).*t55.*(-1.0./2.0)-(DmInv(3,1,:).*t58)./2.0;(t4.*t51)./2.0+(t3.*t53)./2.0;(t4.*t54)./2.0+(t3.*t56)./2.0;(t3.*t58)./2.0+(t4.*t57)./2.0;DmInv(1,3,:).*t51.*(-1.0./2.0)-(DmInv(1,2,:).*t53)./2.0];
    mt4 = [DmInv(1,3,:).*t54.*(-1.0./2.0)-(DmInv(1,2,:).*t56)./2.0;DmInv(1,2,:).*t58.*(-1.0./2.0)-(DmInv(1,3,:).*t57)./2.0;DmInv(2,3,:).*t51.*(-1.0./2.0)-(DmInv(2,2,:).*t53)./2.0;DmInv(2,3,:).*t54.*(-1.0./2.0)-(DmInv(2,2,:).*t56)./2.0;DmInv(2,2,:).*t58.*(-1.0./2.0)-(DmInv(2,3,:).*t57)./2.0;DmInv(3,3,:).*t51.*(-1.0./2.0)-(DmInv(3,2,:).*t53)./2.0;DmInv(3,3,:).*t54.*(-1.0./2.0)-(DmInv(3,2,:).*t56)./2.0;DmInv(3,2,:).*t58.*(-1.0./2.0)-(DmInv(3,3,:).*t57)./2.0;t50.^2./2.0+t52.^2./2.0+t55.^2./2.0-1.0./2.0;t51.^2./2.0+t54.^2./2.0+t57.^2./2.0-1.0./2.0;t53.^2./2.0+t56.^2./2.0+t58.^2./2.0-1.0./2.0];
    mt5 = [(t50.*t51)./2.0+(t52.*t54)./2.0+(t55.*t57)./2.0;(t50.*t53)./2.0+(t52.*t56)./2.0+(t55.*t58)./2.0;(t51.*t53)./2.0+(t54.*t56)./2.0+(t57.*t58)./2.0];
    out = [mt1;mt2;mt3;mt4;mt5];

    range = 12;
    % gradC = pagetranspose([out(1:range,:,:),out(range+1:range*2,:,:),out(range*2+1:range*3,:,:),out(range*3+1:range*4,:,:),out(range*4+1:range*5,:,:),out(range*5+1:range*6,:,:)]);
    gradC = pagetranspose(reshape(out(1:range*6,:,:),12,6,[]));
    constraintC = reshape(out(range*6+1:end,:,:),6,1,[]);
end